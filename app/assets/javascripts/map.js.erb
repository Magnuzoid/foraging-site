var markers, locationMarker;
var geojsonMarkerOptions = {
    radius: 8,
    fillColor: "#ff7800",
    color: "#000",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.8
};
var geojsonMarkerOptions1 = {
    radius: 8,
    fillColor: "#ff2323",
    color: "#000",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.8
};



var path = window.location.pathname;

$(function(){
  if ( $("#pagewrap").hasClass("places") )  {
    getMarkers();
    initMap();
    map.locate({
      watch: false
    });
  }
});

function onEachFeature(feature, layer) {
  // does this feature have a property named popupContent?
  if (feature.properties && feature.properties.popupContent) {
      layer.bindPopup(feature.properties.popupContent);
  }
}

function getMarkers() {
  var test = true;
  markers = $.getJSON( path ).done( function (response) {

      geojsonLayer = L.geoJson(response, {
        onEachFeature: onEachFeature,
        pointToLayer: function (feature, latlng) {

                        if(test == true){
                          test = false;
                          return L.circleMarker(latlng, geojsonMarkerOptions1);
                        }else if (test == false){
                          test = true;
                          return L.circleMarker(latlng, geojsonMarkerOptions);
                        }
                      }
      }).addTo(map);
      map.fitBounds(geojsonLayer.getBounds());
    });

}

function addLocationMarker(){

  var locationIcon = L.icon({
        iconUrl: '<%= image_path('marker-icon.png') %>',
        iconRetinaUrl: '<%= image_path('marker-shadow@2x.png') %>',
        iconSize: [25, 41],
        iconAnchor: [22, 94],
        popupAnchor: [-9, -96],
        shadowUrl: '<%= image_path('marker-shadow.png') %>',
        shadowRetinaUrl: '<%= image_path('marker-shadow@2x.png') %>',
        shadowSize: [41, 41],
        shadowAnchor: [22, 94]
    });
  var center = map.getCenter();

  locationMarker = L.marker( [center.lat, center.lng], {
    draggable: true,
    icon: locationIcon
  }).addTo(map);

  locationMarker.on("dragend", function(){
    var coords = this.getLatLng();
    $("input#place_lat").val(coords.lat);
    $("input#place_lng").val(coords.lng);
  });

}

function initMap() {
  map.options.maxZoom = 10;
  map.options.minZoom = 4;
  /*map.options = {
    'maxZoom': 13,
    'minZoom': 6
  };*/
}

function closeDialouge() {
  $("#new_place").remove();
  $("#newplace").show();
  map.removeLayer(locationMarker);
}

function autoSearch() {
  var searchField = $("#search"),
      searchForm = $("#lookup-form");

  searchField.on("keyup paste", function(e){
    //e.preventDefault();

    //if (searchField.val().length >= 2){
    searchForm.submit();
    //}
  });
}
